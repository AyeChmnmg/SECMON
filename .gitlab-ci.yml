variables:
  reg_password: $reg_password
  reg_username: $reg_username

stages:
  - build
#  - vuln_scan
  - malware_scan
  - test
  - release_image
  - release_github

Build-Image:
  stage: build
  script:
  - docker login registry.gueznet.local:443 -u $reg_username -p $reg_password
  - docker pull registry.gueznet.local:443/repos/secmon:latest || true
  - docker build . -t registry.gueznet.local:443/repos/secmon:$CI_COMMIT_REF_SLUG
  - docker push registry.gueznet.local:443/repos/secmon:$CI_COMMIT_REF_SLUG





Malware-Scan:
  stage: malware_scan
  script:
  - docker login registry.gueznet.local:443 -u $reg_username -p $reg_password
  - docker run -i -t --name secmon-test -v $PWD/:/var/www/secmon -v $PWD/certs:/etc/ssl/secmon --expose 80 --expose 443 -d registry.gueznet.local:443/repos/secmon:$CI_COMMIT_REF_SLUG
  - docker exec secmon-test bash -c 'apt update && apt install -y clamav && freshclam'
  - docker exec secmon-test clamscan -r / | tee scan-results.txt
  allow_failure: true
  artifacts:
    when: on_failure
    paths:
    - scan-results.txt


Test:
  stage: test
  script:
  - docker login registry.gueznet.local:443 -u $reg_username -p $reg_password
  - docker run -i -t --name secmon-test -v $PWD/:/var/www/secmon -v $PWD/certs:/etc/ssl/secmon --expose 80 --expose 443 -d registry.gueznet.local:443/repos/secmon:$CI_COMMIT_REF_SLUG
  - docker exec -it secmon-test bash -c 'cd /var/www/secmon && python3 -c "import secmon_lib" && python3 -c "from secmon_web import *"'
  - docker stop secmon-test && docker rm secmon-test 

Release-Image:
  stage: release_image
  script:
  - docker login registry.gueznet.local:443 -u $reg_username -p $reg_password
  - docker tag registry.gueznet.local:443/repos/secmon:$CI_COMMIT_REF_SLUG registry.gueznet.local:443/repos/secmon:latest
  - docker push registry.gueznet.local:443/repos/secmon:latest


Github-Push:
  stage: release_github
  script:
  - echo ''

